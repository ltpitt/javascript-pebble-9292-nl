name: Update GTFS Data

on:
  # schedule:
  #   # Run daily at 04:00 CET (03:00 UTC in winter, 02:00 UTC in summer)
  #   # Runs after gtfs.ovapi.nl updates at 03:00 UTC
  #   - cron: '0 3 * * *'  # 03:00 UTC daily
  
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-gtfs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Trigger GTFS update on production server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # Set up SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add server to known_hosts
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          
          # Connect to server and trigger update
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd $SERVER_PATH/backend
            
            # Run update script
            ./venv/bin/python update_gtfs.py
            
            # Check if update was successful
            if [ $? -eq 0 ]; then
              echo "✅ GTFS update completed successfully"
              
              # Restart Flask service (adjust based on your deployment)
              # Option 1: systemd service
              # sudo systemctl restart nextride-backend
              
              # Option 2: Docker
              # docker-compose restart backend
              
              # Option 3: Simple process restart
              pkill -f "flask run" || true
              nohup ./venv/bin/python -m flask run --host=0.0.0.0 --port=8000 > logs/flask.log 2>&1 &
            else
              echo "❌ GTFS update failed"
              exit 1
            fi
          EOF
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "⚠️ GTFS update failed! Check logs."
          # Add notification here (Slack, email, etc.)
